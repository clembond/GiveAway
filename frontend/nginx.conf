server {
  listen 80;

  # This block serves your React application's static files
  location / {
    root   /usr/share/nginx/html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }

  # This block acts as a proxy for all API requests
  location /api/ {
    # This tells Nginx to use Docker's internal DNS resolver.
    # Using a variable for the upstream address forces Nginx to resolve
    # the DNS at runtime (when a request is made) instead of at startup,
    # which fixes the race condition.
    resolver 127.0.0.11 valid=10s;
    set $backend_service "backend";
    proxy_pass http://$backend_service:8080;

    # These headers are important to ensure the backend receives
    # the correct information about the original request.
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}